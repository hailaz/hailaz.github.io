---
layout: post
title: gorun
categories: go
---

### 限制 go run 个数

```go
type GoRun struct {
	max   int
	count int
	sync.Mutex
}

func NewGoRun(max int) *GoRun {
	return &GoRun{max: max}
}

func (p *GoRun) CanRun() bool {
	p.Lock()
	defer p.Unlock()
	if p.count < p.max {
		p.count++
		return true
	}
	return false
}
func (p *GoRun) Done() {
	p.Lock()
	defer p.Unlock()
	p.count--
}

func (p *GoRun) Count() int {
	return p.count
}

func (p *GoRun) Run(f func()) {
	defer p.Done()
	f()
}

func main() {
	p := NewGoRun(100)
	for {
		if p.CanRun() {
			go p.Run(func() {
				rand.Seed(time.Now().UnixNano())
				x := rand.Intn(p.max * 100) //生成0-99随机整数
				time.Sleep(time.Millisecond * time.Duration(x))
			})
		}
		fmt.Println(p.Count())
		time.Sleep(time.Millisecond * 100)
	}
}
```
